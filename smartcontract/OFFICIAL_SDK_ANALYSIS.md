# Official RNS SDK Analysis

## Key Discovery: RSKRegistrar.ts Implementation

### 1. Commit-Reveal Flow in Official SDK

The official SDK has a `commitToRegister` function that handles the commit step:

```typescript
async commitToRegister (label: string, owner: string): Promise<{
  secret: string, 
  makeCommitmentTransaction: ContractTransaction, 
  canReveal: ()=> Promise<boolean>, 
  hash: string 
}>
```

**What it does:**
1. Generates a secret using `generateSecret()`
2. Creates commitment hash: `makeCommitment(hashLabel(label), owner, secret)`
3. Commits the hash: `commit(hash)`
4. Returns secret, transaction, and `canReveal` function

### 2. Registration Method

**Important Discovery**: The official SDK uses `transferAndCall` (ERC677 pattern):

```typescript
async register (label: string, owner: string, secret: string, duration: BigNumber, amount: BigNumber, addr?: string): Promise<ContractTransaction> {
  // Encodes data with signature, owner, secret, duration, addr, name
  const data = `${_signature}${_owner}${_secret}${_duration}${_addr}${_name}`
  return this.rifToken.transferAndCall(this.fifsAddrRegistrar.address, amount, data)
}
```

**This is different from our approach!**
- Official SDK: Uses `rifToken.transferAndCall(registrar, amount, encodedData)`
- Our approach: Directly calls `fifsRegistrar.register(...)`

### 3. Registration Signature

The SDK uses a specific signature: `0x5f7b99d5` for FIFS registrar registration.

The encoded data format:
```
| signature  |  4 bytes      - offset  0
| owner      | 20 bytes      - offset  4
| secret     | 32 bytes      - offset 24
| duration   | 32 bytes      - offset 56
| addr       | 20 bytes      - offset 88
| name       | variable size - offset 108
```

### 4. Frontend Flow (Inferred)

Based on the SDK structure, the official frontend likely:

1. **User clicks "Register"**
2. **Frontend calls `commitToRegister`**:
   - Generates secret
   - Creates and commits commitment
   - Returns secret and canReveal function
3. **Frontend shows countdown** (60 seconds)
4. **Frontend polls `canReveal()`** until true
5. **Frontend calls `register`** with the secret
6. **Registration completes**

### 5. Comparison: Official vs Our Implementation

| Aspect | Official SDK | Our Implementation |
|--------|-------------|-------------------|
| Commit | `commitToRegister()` helper | `bulkCommit()` function ✅ |
| Register | `transferAndCall()` (ERC677) | Direct `register()` call |
| Secret | Generated by SDK | User provides (or empty) |
| Flow | Two separate transactions | Two separate transactions ✅ |

### 6. Key Questions

1. **Why does official SDK use `transferAndCall`?**
   - ERC677 allows token transfer with callback
   - Registrar receives tokens and data in one transaction
   - More gas efficient?

2. **Can we use direct `register()` call?**
   - Our contract already approves tokens before calling `register()`
   - Direct call should work if tokens are approved
   - But we need to check if FIFS registrar accepts direct calls

3. **Secret Generation:**
   - Official SDK generates random secret
   - Our frontend uses empty bytes32 (`0x0000...0000`)
   - **Question**: Does empty secret work? Or do we need random secret?

### 7. Recommendation

#### Option A: Match Official SDK Pattern
- Use `transferAndCall` pattern
- Generate random secrets
- Follow exact same flow

#### Option B: Keep Our Approach (Simpler)
- Use direct `register()` calls
- Generate random secrets (not empty)
- Keep commit-reveal flow

**Recommendation: Option B** - Our approach is simpler and should work. We just need to:
1. ✅ Generate random secrets (not empty)
2. ✅ Implement commit-reveal flow in frontend
3. ✅ Keep direct `register()` calls (already approved tokens)

### 8. Action Items

1. **Update Frontend Secret Generation**:
   - Change from empty bytes32 to random secret
   - Store secret between commit and register

2. **Update Frontend Flow**:
   - Add commit step before registration
   - Show countdown timer
   - Auto-trigger register after 60 seconds

3. **Test with Random Secret**:
   - Verify empty secret vs random secret
   - Confirm which works with FIFS registrar

### 9. Code References

- Official SDK: https://github.com/rsksmart/rns-sdk/blob/develop/src/RSKRegistrar.ts
- Our Contract: `smartcontract/contracts/RNSBulkManager.sol`
- Our Frontend: `frontend/lib/hooks/useContract.ts`

